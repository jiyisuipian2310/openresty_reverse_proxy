350a351,400
> 
> void ngx_stream_lua_remove_bytes(ngx_stream_lua_request_t *r, int length, int flag)
> {
>     ngx_connection_t *c = r->connection;
>     if(c->buffer == NULL || c->buffer->pos >= c->buffer->last) {
>         ngx_log_error(NGX_LOG_ERR, r->connection->log, 0, "ngx_stream_lua_remove_bytes, c->buffer == NULL or c->buffer->pos >= c->buffer->last");
>         return;
>     }
> 
>     if(flag > 0) {
>         ngx_log_error(NGX_LOG_INFO, r->connection->log, 0, "ngx_stream_lua_remove_bytes, proxyData: %*s, remove length: %d", 
>             c->buffer->last - c->buffer->pos, 
>             c->buffer->pos, 
>             length);
>     }
>     c->buffer->pos += length;
> }
> 
> void ngx_stream_lua_add_custom_message(ngx_stream_lua_request_t *r, const unsigned char *custom_msg, size_t custom_msg_len, int flag)
> {
>     ngx_connection_t *c = r->connection;
>     if (c->buffer == NULL || c->buffer->pos >= c->buffer->last) {
>         ngx_log_error(NGX_LOG_ERR, r->connection->log, 0, "ngx_stream_lua_add_custom_message, c->buffer == NULL or c->buffer->pos >= c->buffer->last");
>         return;
>     }
>     
>     //获取原始数据
>     u_char *orig_data = c->buffer->pos;
>     size_t orig_len = c->buffer->last - c->buffer->pos;
>     
>     //创建新缓冲区
>     ngx_buf_t *new_buf = ngx_create_temp_buf(r->pool, custom_msg_len + orig_len);
>     if (new_buf == NULL) {
>         ngx_log_error(NGX_LOG_ERR, r->connection->log, 0, "ngx_stream_lua_add_custom_message, ngx_create_temp_buf failed");
>         return;
>     }
>     
>     //构建新数据
>     u_char *p = new_buf->pos;
>     p = ngx_copy(p, custom_msg, custom_msg_len);
>     p = ngx_copy(p, orig_data, orig_len);
>     new_buf->last = p;
>     
>     //重要：更新连接中的缓冲区
>     c->buffer = new_buf;
>     if(flag > 0) {
>         ngx_log_error(NGX_LOG_INFO, r->connection->log, 0, "ngx_stream_lua_add_custom_message, new message: %*s", 
>             c->buffer->last - c->buffer->pos, c->buffer->pos);
>     }
> }
